<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coretree.defaultconfig.mapper.CallMapper">

    <resultMap id="callMap" type="com.coretree.defaultconfig.mapper.Call">
        <id     property="idx"    		column="idx" />
        <result property="custs_idx" 	column="custs_idx" />
        <result property="cust_tel"     column="cust_tel" />
        <result property="startdate"    column="startdate" />
        <result property="enddate"    	column="enddate" />
        <result property="memo"      	column="memo" />
        <result property="status"      	column="status" />
    </resultMap>
    
    <select id="count" resultType="java.lang.Integer">
    	select count(idx) from calls where cast(regdate as date)=cast(current_timestamp as date)
    </select>
    
    <select id="selectAll" parameterType="map" resultMap="callMap">
    	select first #{rowsperpage} skip ((#{curpage} - 1) * #{rowsperpage})
			idx
			, (select uname from customers where idx=a.custs_idx) as cust_name
			, custs_idx, direction, cust_tel, startdate, enddate, memo, regdate
			, iif(datediff(second from startdate to enddate) is null, 0, datediff(second from startdate to enddate)) diff
			from calls a
			where cast(regdate as date)=cast(current_timestamp as date)
			order by regdate desc
    </select>
    
    <select id="selectByIdx" resultMap="callMap">
    	select idx, custs_idx, direction, cust_tel, startdate, enddate, memo, regdate
			from calls
			where idx=#{idx}
			order by regdate desc
    </select>
    
    <select id="selectByTxt" resultMap="callMap">
    	select first a.idx, b.uname, a.direction, a.cust_tel, a.startdate, a.enddate, a.memo, a.regdate
			from calls a join customers b
				on a.idx=b.customers_idx
			where a.title like #{txt} or b.uname like #{txt}
			order by regdate desc
    </select>
    
    <insert id="add" useGeneratedKeys="true" keyProperty="idx" keyColumn="idx">
    	insert into calls
    		(cust_tel, startdate)
    		values
    		(#{cust_tel}, #{startdate})
    </insert>
    
    <update id="modiStatus">
    	update calls
    		set status=#{status}, enddate=#{enddate}
    	where idx=#{idx}
    </update>
    
    <delete id="del">
		delete from calls where idx=#{idx}
    </delete>
    
    <delete id="delAll" parameterType="java.util.List">
		delete from calls where
		<foreach collection="list" item="item" separator=",">
			 idx=#{item.idx}
		</foreach>
    </delete>    
</mapper>