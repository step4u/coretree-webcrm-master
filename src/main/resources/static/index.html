<!DOCTYPE html>
<html ng-app="app" id="ng-app">
<head>
	<title>CRM with IPCC - Coretree</title>
  	<meta charset="utf-8">
  	<meta name="viewport" content="width=device-width, initial-scale=1">
  	
	<script type="text/javascript" src="/resources/jquery/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

<!--     <link rel="stylesheet" href="/resources/jquery-ui-1.11.4.custom/jquery-ui.min.css" />
	<script src="/resources/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script> -->
    
    <link rel="stylesheet" href="/resources/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="resources/bootstrap/css/bootstrap-theme.min.css" />
	<script src="/resources/bootstrap/js/bootstrap.min.js"></script>
	
	<script src="/resources/moment/moment-with-locales.min.js"></script>
	<link rel="stylesheet" href="/resources/eonasdan-bootstrap-datetimepicker/bootstrap-datetimepicker.min.css" />
	<script src="/resources/eonasdan-bootstrap-datetimepicker/bootstrap-datetimepicker.min.js"></script>
	
	<script src="https://code.angularjs.org/1.4.8/angular.min.js"></script>
    <script src="https://code.angularjs.org/1.4.8/angular-touch.min.js"></script>
    <script src="https://code.angularjs.org/1.4.8/angular-animate.min.js"></script>
    <script src="https://code.angularjs.org/1.4.8/angular-route.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.8/angular-cookies.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.14.3/ui-bootstrap-tpls.min.js"></script>
    <script src="http://angular-ui.github.io/ui-router/release/angular-ui-router.js"></script>
    
    <script src="/resources/angularjs/grid-ui/grunt-scripts/csv.js"></script>
    <script src="/resources/angularjs/grid-ui/grunt-scripts/pdfmake.js"></script>
    <script src="/resources/angularjs/grid-ui/grunt-scripts/vfs_fonts.js"></script>
    
	<script src="/resources/angularjs/grid-ui/3.0.7/ui-grid.min.js"></script>
    <link rel="stylesheet" href="/resources/angularjs/grid-ui/3.0.7/ui-grid.min.css" />
    
    <link rel="stylesheet" href="/resources/css/simple-sidebar.css" />

    <script src="script1.js"></script>
    <script src="resources/js/contextMenu.js"></script>
    
    <script src="resources/js/sockjs-0.3.4.js"></script>
    <script src="resources/js/stomp.js"></script>

    <link rel="stylesheet" href="resources/css/main.css" />    
	<script src="resources/js/MessageValues.js"></script>
	<script src="resources/js/local.js"></script>
</head>
<body>
    <div id="wrapper">
		<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
			<div class="navbar-header">
			    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
			        <span class="sr-only">Toggle navigation</span>
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			    </button>
			    <a class="navbar-brand" href="/">Coretree</a>
			    <button type="button" class="navbar-toggle" id="menu-toggle">
			        <span class="sr-only">Toggle navigation</span>
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			    </button>
			</div>
			<div class="collapse navbar-collapse navbar-ex1-collapse">
			    <ul class="nav navbar-nav navbar-right">
			    	<li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="userstatus"><span class="glyphicon glyphicon-plus-sign"></span> 대기중</a>
                        <ul class="dropdown-menu">
                        	<li class="dropdown-header">현재상태 설정</li>
                            <li class="divider"></li>
                            <li><a href="#"><span class="glyphicon glyphicon-plus-sign"></span> 대기중</a></li>
                            <li><a href="#"><span class="glyphicon glyphicon-ok-sign"></span> 통화중</a></li>
                            <li><a href="#"><span class="glyphicon glyphicon-minus-sign"></span> 자리비움</a></li>
                            <li><a href="#"><span class="glyphicon glyphicon-remove-sign"></span> 수신거부</a></li>
                        </ul>
                    </li>
			    	<li class="dropdown">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown" id="systeminfo"> 시스템 정상 (8001)</a>
                        <ul class="dropdown-menu">
                        	<li class="dropdown-header">시스템 정보</li>
                            <li class="divider"></li>
                            <li><a href="#"> 디스크용량 : 565GB</a></li>
                            <li><a href="#"> 금일 통화 : 476건</a></li>
                            <li><a href="#"> 주간 통화 : 2223건</a></li>
                            <li><a href="#"> 전체 통화  : 5655789건</a></li>
                        </ul>
		        	</li>
			    	<li class="dropdown">
						<a href="#" id="logout"> 로그아웃</a>
		        	</li>
			    </ul>
			</div>
		</nav>
		
		<!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li>
                    <a href="#">주소록</a>
                </li>
                <li>
                	<ul style="list-style: none; margin: 0; padding-left: 15px;">
                		<li>
                			<a href="#/addr/1" id="publicaddr">공용 주소록 </a>
                		</li>
                		<li id="collapse1" class="panel-collapse collapse in">
                			<ul style="list-style: none; margin: 0; padding-left: 25px;">
                				<li><a href="#/addr/11">협력업체</a></li>
                				<li><a href="#/addr/12">거래처</a></li>
                				<li><a href="#/addr/13">고객</a></li>
                			</ul>
                		</li>
            			<li>
                			<a href="#/addr/2" id="personaladdr">개인 주소록</a>
                		</li>
                		<li id="collapse2" class="panel-collapse collapse in">
                			<ul style="list-style: none; margin: 0; padding-left: 25px;">
                				<li><a href="#/addr/21">협력업체</a></li>
                				<li><a href="#/addr/22">거래처</a></li>
                				<li><a href="#/addr/23">고객</a></li>
                			</ul>
                		</li>
                	</ul>
                </li>
                <li>
                    <a href="#/calls">통화내역</a>
                </li>
                <li>
                    <a href="#/smses">SMS내역</a>
                </li>
                <li style="display: none;" class="ADMIN">
                    <a href="#/records">녹취내역</a>
                </li>
<!--                 
                <li style="display: none;" class="ADMIN">
                    <a href="counsellorcalls">상담원통화내역</a>
                </li>
 -->                
                <li style="display: none;" class="ADMIN">
                    <a href="#/exts">내선관리</a>
                </li>
                <li style="display: none;" class="ADMIN">
                    <a href="#/counsellors">상담원관리</a>
                </li>
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->
        
		<div id="page-wrapper">
			<div class="row">
				<div class="col-lg-9">
					<div class="row">
	                    <div class="alert alert-dismissable alert-info col-lg-8">
	                        <!-- <button data-dismiss="alert" class="close" type="button">&times;</button> -->
	                        Welcome to the CRM for ThinkBox Cloud.
	                        <br />
	                        You can see a information of Telephony in this box.
	                    </div>
	                    <div class="col-lg-4">
	                    	<input type="text" class="form-control" id="callnumber" placeholder="전화번호" style="margin-bottom: 14px;">
	                    	<button type="button" class="btn btn-primary disabled btn-sm" id="btnCall">전화걸기</button>
	                    	<button type="button" class="btn btn-primary btn-sm" id="btnPickup">당겨받기</button>
	                    	<button type="button" class="btn btn-primary disabled btn-sm" id="btnTransfer">돌려주기</button>
	                    	<button type="button" class="btn btn-primary disabled btn-sm" id="btnHold">보류</button>
	                    </div>
                    </div>
                    <div class="row">
						<!-- <div ui-view="maincontent"></div> -->
						<div ui-view="content"></div>
					</div>
	        	</div>
		        <div class="col-lg-3">
		        	<div ng-controller="CtrlCallStatus" id="ctrlcallstatus">
		        		<div ui-grid="gridOptions" class="grid_teller_status"></div>
		        		<!-- <button type="button" class="btn btn-primary btn-sm" id='scopetest'>테스트</button> -->
		        	</div>
					<div ng-controller="CtrlTelStatus" style="margin-top: 15px;" id="ctrlextstatus">
						<div ui-grid="gridOptions" class="grid_tels"></div>
					</div>
					<!-- 
					<button type="button" class="btn btn-primary btn-sm" id='btn_connect'>Connect</button>
					<button type="button" class="btn btn-primary btn-sm" id='btn_disconnect'>Disconnect</button>
					<button type="button" class="btn btn-primary btn-sm" id='btn_makecall'>MakeCall</button>
					<button type="button" class="btn btn-primary btn-sm" id='btn_dropcall'>DropCall</button>
					<button type="button" class="btn btn-primary btn-sm" id='btn_holdcall'>HoldCall</button>
					<button type="button" class="btn btn-primary btn-sm" id='btn_activecall'>ActiveCall</button>
					<button type="button" class="btn btn-primary btn-sm" id='btn_transfer'>Transfer</button>
					<button type="button" class="btn btn-primary btn-sm" id='btn_pickup'>PickUp</button>
					<button type="button" class="btn btn-primary btn-sm" id='btn_reqextstatus'>Requset Extension Status</button>
					 -->
		        </div>
			</div>
		</div>
    </div>

<!-- 
    <footer class="footer">
      <div class="container">
        <p class="text-muted">ⓒ Copyright 2015 Coretree Corp. All Rights Reserved.</p>
      </div>
    </footer>
 -->

<!-- Customer Modal -->
<div class="modal fade" id="addCustomer" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">&times;</button>
				<h4 class="modal-title">고객 등록</h4>
			</div>
			<div class="modal-body">
        		<!-- <p>This is a large modal.</p>  -->
				<div class="alert alert-warning fade in" style="display: none;" id="alertcust">
		  			<strong>Warning!</strong> This alert box could indicate a warning that might need attention.
				</div>
        		<div class="row">
					<div class="form-group col-sm-6" ng-controller="CtrlGroups">
						<input type="hidden" id="idx">
				    	<label class="control-label" for="depthorder">그룹</label>
				    	<select class="form-control" ng-model="modeloption" id="depthorder" ng-options="option.depthorder as option.txt for option in options">
				    		<option value="">:: 그룹선택 ::</option>
				    	</select>
				  	</div>
			  	</div>
			  	<div class="row">
					<div class="form-group col-sm-6">
				    	<label for="uname">이름</label>
				    	<input type="text" class="form-control" id="uname" placeholder="이름">
				  	</div>
				  	<div class="form-group col-sm-6">
				    	<label for="company">회사</label>
				    	<input type="text" class="form-control" id="company" placeholder="회사">
				  	</div>
			  	</div>
			  	<div class="row">
				  	<div class="form-group col-sm-6">
				    	<label for="tel">전화</label>
				    	<input type="text" class="form-control" id="tel" placeholder="전화">
				  	</div>
				  	<div class="form-group col-sm-6">
				    	<label for="cellular">휴대전화</label>
				    	<input type="text" class="form-control" id="cellular" placeholder="휴대전화">
				  	</div>
			  	</div>
			  	<div class="row">
				  	<div class="form-group col-sm-6">
				    	<label for="extension">내선</label>
				    	<input type="text" class="form-control" id="extension" placeholder="내선">
			    	</div>
			    	<div class="form-group col-sm-6">
				    	<label for="posi">직급</label>
				    	<input type=text class="form-control" id="posi" placeholder="직급">
				  	</div>
			  	</div>
			  	<div class="row">
				  	<div class="form-group col-sm-8">
				    	<label for="email">이메일</label>
				    	<input type="text" class="form-control" id="email" placeholder="이메일">
			    	</div>
			  	</div>
      		</div>
      		<div class="modal-footer">
        		<button type="button" class="btn btn-primary" id="btnSave">저장</button>
        		<button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
      		</div>
    	</div>
  	</div>
</div>
<audio controls id="audioplayer" style="display: none;"></audio>
</body>
	<script src="resources/apps/controller_callstatus.js"></script>
	<script src="resources/apps/controller_telstatus.js"></script>
	<script src="resources/apps/controller_customers.js"></script>
	<script src="resources/apps/controller_calls.js"></script>
	<script src="resources/apps/controller_smses.js"></script>
	<script src="resources/apps/controller_records.js"></script>
	<script src="resources/apps/controller_exts.js"></script>
	<script src="resources/apps/controller_counsellors.js"></script>
	<script src="resources/apps/CtrlGroups.js"></script>

	<script>
	/*
	    (function() {
	        var socket = new SockJS('/webcrm');
	        var stompClient = Stomp.over(socket);
	
	        var appModel = new ApplicationModel(stompClient);
	        ko.applyBindings(appModel);
	
	        appModel.connect();
	        appModel.pushNotification("Trade results take a 2-3 second simulated delay. Notifications will appear.");
		})();
	*/
	
		var worker;
		function connect() {
	        worker = new Worker('resources/js/ExtStatus_multi-worker.js');

	        /* 	        worker.addEventListener('message', function(e) {
	        	// update_ext_status(e.data);
	        	console.log("worker front side got message...." + e.data);
	        }); */
	        
	        worker.onmessage = function (event) {
	        	// console.log("worker front side got message...." + event.data);
	        	update_ext_status(event.data);
			};
	
	        var command = {
	        	cmd: 'connect'
	        }
	        worker.postMessage(JSON.stringify(command));
		}
	
		var crmidentity;
		var whoami;
		var stompClient;
		var group;
		
	    function connect2() {
	        var socket = new SockJS('/webcrm');
	        stompClient = Stomp.over(socket);
	        stompClient.outgoing = 10000;
	        stompClient.incoming = 10000;
	        
	        stompClient.connect({}, function(frame) {
	        	whoami = frame.headers['user-name'];
	            //console.log('index.html Connected: ' + frame);

	            /*
	            stompClient.subscribe("/user/topic/callstatus", function(message) {
	            	console.log('index.html /topic/callstatus: ' + JSON.parse(message.body));
	            });
	            */

	            stompClient.subscribe("/topic/ext.status.*", function(message) {
	            	var data = JSON.parse(message.body);
	                console.log("/topic/ext.status: " + data.extension + ", " + data.status);
	                console.log("/topic/ext.status: " + data.extension + ", " + message.body);
	                update_ext_status(data);
	            });
	            
	            stompClient.subscribe("/user/queue/groupware", function(message) {
	            	// console.log('/user/queus/groupware: ' + JSON.parse(message.body));
	            	console.log('/user/queus/groupware: ' + message.body);
	            	
	            	TreatMySelf(JSON.parse(message.body));
				});
	            
	            stompClient.subscribe("/user/queue/errors", function(message) {
	            	console.log('index.html /app/queue/errors: ' + JSON.parse(message.body));
				});
	        });
	    }
	    
	    function disconnect() {
	        if (stompClient != null) {
	            stompClient.disconnect();
	        }
	        // setConnected(false);
	        console.log("Disconnected");
	    }
	    
	    function sendName() {
	        var name = document.getElementById('name').value;
	        stompClient.send("/user/hello", {}, JSON.stringify({ 'name': name }));
	    }
	    
		$(document).ready(function(){
			$('[data-toggle="tooltip"]').tooltip();
			
			$('a').click(function(event){
				var str = this.toString();
				str = str.split('/#/');
				// alert(str.length);
				if (str.length < 2)
					event.preventDefault();
			});
			
		    $("#menu-toggle").click(function(e) {
		        e.preventDefault();
		        $("#wrapper").toggleClass("toggled");
		    });
		    
/* 		    $("#publicaddr").click(function(e){
		    	e.preventDefault();
		    	location.href="/#/addr/1/0";
		    });
		    $("#personaladdr").click(function(e){
		    	e.preventDefault();
		    	location.href="/#/addr/2/0";
		    }); */
		    
		    var tmpidentity = $.cookie("crm.identity");
		    crmidentity = JSON.parse(tmpidentity);
		    //console.log(crmidentity.role);
		    // connect();
		});
	</script>
	
	<script>
	    function update_ext_status(data){
	    	if (crmidentity.ext == data.extension) {
	            if (data.cmd == UC_CALL_STATE_IDLE || data.cmd == UC_CALL_STATE_UNREG) {
	                currentCallInfo.cmd = 0;
	                currentCallInfo.ext = '';
	                currentCallInfo.caller = '';
	                currentCallInfo.callee = '';
	                currentCallInfo.unconditional = '';
	                currentCallInfo.status = -1;
	            } else {
	                currentCallInfo.cmd = data.cmd;
	                currentCallInfo.ext = data.extension;
	                currentCallInfo.caller = data.caller;
	                currentCallInfo.callee = data.callee;
	                currentCallInfo.unconditional = data.unconditional;
	                currentCallInfo.status = data.status;
	            }
	            console.log("Transfer3: " + JSON.stringify(currentCallInfo));
	    	}
            
	    	var scope = angular.element($("#ctrlextstatus")).scope();
		    scope.$apply(function () {
		        scope.updateExtStatus(data);
		    });
	    }
	    
	    var trade = {
                cmd : 0,
                extension : '3001',
                caller : '',
                callee : '',
                unconditional : '',
                status: -1
              };
	
		$(document).ready(function(){
		    $("#btn_connect").click(function(){
		    	connect();
		    	//connect2();
		    });
			
		    $("#btn_disconnect").click(function(){
				disconnect();
		    });
		    
		    $("#btn_makecall").click(function(){
		    	// makecall
		        trade = {
		                cmd : 74,
		                extension : '3001',
		                caller : '3001',
		                callee : '01045455962',
		                unconditional : '',
		                status: -1
		              };
		        
		     	stompClient.send("/app/traders", {}, JSON.stringify(trade));
		        console.log("socktest sock sent");
		    });
		    
		    $("#btn_dropcall").click(function(){
		    	// pickup
		        trade = {
		                cmd : 76,
		                extension : '3001',
		                caller : '3001',
		                callee : '01045455962',
		                unconditional : '',
		                status: -1
		              };
		        
		     	stompClient.send("/app/traders", {}, JSON.stringify(trade));
		        console.log("socktest sock sent");
		    });
		    
		    $("#btn_holdcall").click(function(){
		    	// pickup
		        trade = {
		                cmd : 82,
		                extension : '3001',
		                caller : '01045455962',
		                callee : '3001',
		                unconditional : '',
		                status: -1
		              };
		        
		     	stompClient.send("/app/traders", {}, JSON.stringify(trade));
		        console.log("socktest sock sent");
		    });
		    
		    $("#btn_activecall").click(function(){
		    	// pickup
		        trade = {
		                cmd : 84,
		                extension : '3001',
		                caller : '01045455962',
		                callee : '3001',
		                unconditional : '',
		                status: -1
		              };
		        
		     	stompClient.send("/app/traders", {}, JSON.stringify(trade));
		        console.log("socktest sock sent");
		    });
		    
		    $("#btn_transfer").click(function(){
		    	// transfer
		        trade = {
		                cmd : 86,
		                extension : '3001',
		                caller : '01045455962',
		                callee : '3001',
		                unconditional : '3002',
		                status: -1
		              };
		        
		     	stompClient.send("/app/traders", {}, JSON.stringify(trade));
		        console.log("socktest sock sent");
		    });
		    
		    $("#btn_pickup").click(function(){
		    	// pickup
		        trade = {
		                cmd : 80,
		                extension : '3002',
		                caller : '',
		                callee : '3001',
		                unconditional : '',
		                status: -1
		              };
		        
		     	stompClient.send("/app/traders", {}, JSON.stringify(trade));
		        console.log("socktest sock sent");
		    });
		    
		    $("#btn_reqextstatus").click(function(){
		    	// Requset Extension Status
		        trade = {
		                cmd: 64,
		                extension: '3001',
		                caller: '3001',
		                callee: '3001',
		                unconditional: '3001',
		                status: -1
		              };
		        
		     	stompClient.send("/app/traders", {}, JSON.stringify(trade));
		        console.log("socktest sock sent");
		    });
		    
		    if (crmidentity.role == "ROLE_ADMIN") {
		    	$(".ADMIN").css("display", "inline");
		    }
		    
		    $("#logout").click(function(){
		    	disconnect();
		    	location.href = "/logout.html";
		    });
		    
		    connect2();
		});
	</script>
	<style>
		.modal-header, h4, .close {
		    background-color: #3175AF;
		    color:white !important;
		    text-align: center;
		    font-size: 30px;
		}
		.modal-footer {
		    background-color: #f9f9f9;
		}
	</style>
</html>
