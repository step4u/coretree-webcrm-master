<!DOCTYPE html>
<head>
<meta charset="UTF-8" />
<title>SoundManager 2: Bar UI Player (prototype)</title>
<!--meta name="robots" content="noindex" /-->
<!--meta name="viewport" content="width=500, initial-scale=1"-->
<!--script type="text/javascript" src="../../script/soundmanager2.js"></script-->
<!--script src="script/bar-ui.js"></script-->
<script src="/resources/jquery/jquery.min.js"></script>
<link rel="stylesheet" href="resources/css/bar-ui.css" />
<style>
.play
</style>
<script id="jsbin-javascript">
	var url = 'http://static.kevvv.in/sounds/callmemaybe.mp3';
	window.player;
	// playerElement = null;
	$(document).ready(function(){
		$('#doplay').click(function(){
			url = '/getstream2/test';
			console.log('window.player.playing : ' + window.player.playing);
			if (window.player.playing) {
				window.player.close();
			}
			window.player = new Player(url, document.querySelector('#player'));
			console.log('window.player.gainNode : ' + window.player.gainNode);
			// window.player.gainNode.gain.value = 0.1;
		});
	});

	function Player ( url, el ) {
	  this.ac = new ( window.AudioContext || webkitAudioContext )();
	  this.url = url;
	  this.el = el;
	  this.button = el.querySelector('.sm2-button-bd');
	  this.track = el.querySelector('.sm2-progress-track');
	  this.progress = el.querySelector('.sm2-progress-bar');
	  this.scrubber = el.querySelector('.sm2-progress-ball');
	  this.message = el.querySelector('#playertitle');
	  this.message.innerHTML = 'Loading...';
	  this.bindEvents();
	  this.fetch();
	}
	
	Player.prototype.close = function() {
		// this.pause();
		this.ac.close();
	};

	Player.prototype.bindEvents = function() {
	  this.button.addEventListener('click', this.toggle.bind(this));
	  this.scrubber.addEventListener('mousedown', this.onMouseDown.bind(this));
	  window.addEventListener('mousemove', this.onDrag.bind(this));
	  window.addEventListener('mouseup', this.onMouseUp.bind(this));
	};


	Player.prototype.fetch = function() {
	  var xhr = new XMLHttpRequest();
	  xhr.open('GET', this.url, true);
	  xhr.responseType = 'arraybuffer';
	  xhr.onload = function() {
		this.decode(xhr.response);
		console.log('media file is loaded...');
	  }.bind(this);
	  xhr.send();
	};

	Player.prototype.decode = function( arrayBuffer ) {
	  this.ac.decodeAudioData(arrayBuffer, function( audioBuffer ) {
		this.message.innerHTML = '';
		this.buffer = audioBuffer;
		this.draw();
		this.play();
	  }.bind(this));
	};

	Player.prototype.connect = function() {
	  if ( this.playing ) {
		this.pause();
	  }
	  this.source = this.ac.createBufferSource();
	  this.source.buffer = this.buffer;
	  this.gainNode = this.ac.createGain();
	  this.source.connect(this.gainNode);
	  // this.source.connect(this.ac.destination);
	  this.gainNode.connect(this.ac.destination);
	  /*
 	  this.gainNode.gain.value = 0.1;
		console.log('gainNode : ' + this.gainNode);
		console.log('gainNode.value : ' + this.gainNode.gain.value);
	  */
	  console.log('passed through connect : ' + this.gainNode.gain.value);
	};

	Player.prototype.play = function( position ) {
	  this.connect();
	  this.position = typeof position === 'number' ? position : this.position || 0;
	  this.startTime = this.ac.currentTime - ( this.position || 0 );
	  this.source.start(this.ac.currentTime, this.position);
	  this.playing = true;
	  
	  utils.css.swap(this.button, 'playing', 'paused');
	};

	Player.prototype.pause = function() {
	  if ( this.source ) {
		this.source.stop(0);
		this.source = null;
		this.position = this.ac.currentTime - this.startTime;
		this.playing = false;
		
		utils.css.swap(this.button, 'paused', 'playing');
	  }
	};

	Player.prototype.seek = function( time ) {
	  if ( this.playing ) {
		this.play(time);
	  }
	  else {
		this.position = time;
	  }
	};

	Player.prototype.updatePosition = function() {
	  this.position = this.playing ? 
		this.ac.currentTime - this.startTime : this.position;
	  if ( this.position >= this.buffer.duration ) {
		this.position = this.buffer.duration;
		this.pause();
	  }
	  return this.position;
	};

	Player.prototype.toggle = function() {
	  if ( !this.playing ) {
		this.play();
	  }
	  else {
		this.pause();
	  }
	};

	Player.prototype.onMouseDown = function( e ) {
	  this.dragging = true;
	  this.startX = e.pageX;
	  this.startLeft = parseInt(this.scrubber.style.left || 0, 10);
	};

	Player.prototype.onDrag = function( e ) {
	  var width, position;
	  if ( !this.dragging ) {
		return;
	  }
	  width = this.track.offsetWidth;
	  position = this.startLeft + ( e.pageX - this.startX );
	  position = Math.max(Math.min(width, position), 0);
	  this.scrubber.style.left = position + 'px';
	};

	Player.prototype.onMouseUp = function() {
	  var width, left, time;
	  if ( this.dragging ) {
		width = this.track.offsetWidth;
		left = parseInt(this.scrubber.style.left || 0, 10);
		time = left / width * this.buffer.duration;
		this.seek(time);
		this.dragging = false;
	  }
	};

	Player.prototype.draw = function() {
	  var progress = ( this.updatePosition() / this.buffer.duration ),
		width = this.track.offsetWidth;
	  if ( this.playing ) {
		this.button.classList.add('fa-pause');
		this.button.classList.remove('fa-play');
	  } else {
		this.button.classList.add('fa-play');
		this.button.classList.remove('fa-pause');
	  }
	  this.progress.style.width = ( progress * width ) + 'px';
	  if ( !this.dragging ) {
		this.scrubber.style.left = ( progress * width ) + 'px';
	  }
	  requestAnimationFrame(this.draw.bind(this));
	};
	

	// 유틸리티
	utils = {
		array: (function() {
			function compare(property) {
				var result;
				return function(a, b) {

					if (a[property] < b[property]) {
						result = -1;
					} else if (a[property] > b[property]) {
						result = 1;
					} else {
						result = 0;
					}
					return result;
				};
			}

			function shuffle(array) {
				// Fisher-Yates shuffle algo
				var i, j, temp;
				for (i = array.length - 1; i > 0; i--) {
					j = Math.floor(Math.random() * (i+1));
					temp = array[i];
					array[i] = array[j];
					array[j] = temp;
				}
				return array;
			}

			return {
				compare: compare,
				shuffle: shuffle
			};
		}()),

		css: (function() {
			function hasClass(o, cStr) {
				return (o.className !== undefined ? new RegExp('(^|\\s)' + cStr + '(\\s|$)').test(o.className) : false);
			}

			function addClass(o, cStr) {
				if (!o || !cStr || hasClass(o, cStr)) {
					return false; // safety net
				}
				o.className = (o.className ? o.className + ' ' : '') + cStr;
			}

			function removeClass(o, cStr) {
				if (!o || !cStr || !hasClass(o, cStr)) {
					return false;
				}
				o.className = o.className.replace(new RegExp('( ' + cStr + ')|(' + cStr + ')', 'g'), '');
			}

			function swapClass(o, cStr1, cStr2) {
				var tmpClass = {
					className: o.className
				};
				removeClass(tmpClass, cStr1);
				addClass(tmpClass, cStr2);
				o.className = tmpClass.className;
			}

			function toggleClass(o, cStr) {
				var found,
				method;

				found = hasClass(o, cStr);
				method = (found ? removeClass : addClass);
				method(o, cStr);
			        // indicate the new state...
					return !found;
			}

			return {
				has: hasClass,
				add: addClass,
				remove: removeClass,
				swap: swapClass,
				toggle: toggleClass
			};
		}()),

		dom: (function() {
			function getAll(param1, param2) {
				var node,
				selector,
				results;

				if (arguments.length === 1) {
					// .selector case
					node = document.documentElement;
					// first param is actually the selector
					selector = param1;
				} else {
					// node, .selector
					node = param1;
					selector = param2;
				}

				// sorry, IE 7 users; IE 8+ required.
				if (node && node.querySelectorAll) {
					results = node.querySelectorAll(selector);
				}

				return results;
			}

			function get(/* parentNode, selector */) {
				var results = getAll.apply(this, arguments);
				// hackish: if an array, return the last item.
				if (results && results.length) {
					return results[results.length-1];
				}

				// handle "not found" case
				return results && results.length === 0 ? null : results;
			}

			function ancestor(nodeName, element, checkCurrent) {
				var result;

				if (!element || !nodeName) {
					return element;
				}

				nodeName = nodeName.toUpperCase();

				// return if current node matches.
				if (checkCurrent && element && element.nodeName === nodeName) {
					return element;
				}

				while (element && element.nodeName !== nodeName && element.parentNode) {
					element = element.parentNode;
				}

				return (element && element.nodeName === nodeName ? element : null);
			}

			return {
				ancestor: ancestor,
				get: get,
				getAll: getAll
			};
		}()),

		position: (function() {
			function getOffX(o) {
				// http://www.xs4all.nl/~ppk/js/findpos.html
				var curleft = 0;

				if (o.offsetParent) {
					while (o.offsetParent) {
						curleft += o.offsetLeft;
						o = o.offsetParent;
					}
				} else if (o.x) {
					curleft += o.x;
				}
				return curleft;
			}

			function getOffY(o) {
				// http://www.xs4all.nl/~ppk/js/findpos.html
				var curtop = 0;

				if (o.offsetParent) {
					while (o.offsetParent) {
						curtop += o.offsetTop;
						o = o.offsetParent;
					}
				} else if (o.y) {
					curtop += o.y;
				}
				return curtop;
			}

			return {
				getOffX: getOffX,
				getOffY: getOffY
			};
		}()),

		style: (function() {
			function get(node, styleProp) {
				// http://www.quirksmode.org/dom/getstyles.html
				var value;

				if (node.currentStyle) {
					value = node.currentStyle[styleProp];
				} else if (window.getComputedStyle) {
					value = document.defaultView.getComputedStyle(node, null).getPropertyValue(styleProp);
				}
				return value;
			}
			
			return {
				get: get
			};
		}()),

		events: (function() {
			var add, remove, preventDefault;
			
			add = function(o, evtName, evtHandler) {
				// return an object with a convenient detach method.
				var eventObject = {
					detach: function() {
						return remove(o, evtName, evtHandler);
					}
				};
				if (window.addEventListener) {
					o.addEventListener(evtName, evtHandler, false);
				} else {
					o.attachEvent('on' + evtName, evtHandler);
				}
				return eventObject;
			};

			remove = (window.removeEventListener !== undefined ? function(o, evtName, evtHandler) {
				return o.removeEventListener(evtName, evtHandler, false);
			} : function(o, evtName, evtHandler) {
				return o.detachEvent('on' + evtName, evtHandler);
			});

			preventDefault = function(e) {
				if (e.preventDefault) {
					e.preventDefault();
				} else {
					e.returnValue = false;
					e.cancelBubble = true;
				}
				return false;
			};

			return {
				add: add,
				preventDefault: preventDefault,
				remove: remove
			};
		}()),

		features: (function() {
			var getAnimationFrame,
			localAnimationFrame,
			localFeatures,
			prop,
			styles,
			testDiv,
			transform;

			testDiv = document.createElement('div');

			/**
			* hat tip: paul irish
			* http://paulirish.com/2011/requestanimationframe-for-smart-animating/
			* https://gist.github.com/838785
			*/

			localAnimationFrame = (window.requestAnimationFrame
				|| window.webkitRequestAnimationFrame
				|| window.mozRequestAnimationFrame
				|| window.oRequestAnimationFrame
				|| window.msRequestAnimationFrame
				|| null);

				// apply to window, avoid "illegal invocation" errors in Chrome
				getAnimationFrame = localAnimationFrame ? function() {
					return localAnimationFrame.apply(window, arguments);
				} : null;

			function has(prop) {
				// test for feature support
				var result = testDiv.style[prop];
				return (result !== undefined ? prop : null);
			}

			// note local scope.
			localFeatures = {
				transform: {
					ie: has('-ms-transform'),
					moz: has('MozTransform'),
					opera: has('OTransform'),
					webkit: has('webkitTransform'),
					w3: has('transform'),
					prop: null // the normalized property value
				},

				rotate: {
					has3D: false,
					prop: null
				},

				getAnimationFrame: getAnimationFrame
			};

			localFeatures.transform.prop = (
				localFeatures.transform.w3 ||
				localFeatures.transform.moz ||
				localFeatures.transform.webkit ||
				localFeatures.transform.ie ||
				localFeatures.transform.opera
			);

			function attempt(style) {
				try {
					testDiv.style[transform] = style;
				} catch(e) {
					// that *definitely* didn't work.
					return false;
				}
				// if we can read back the style, it should be cool.
				return !!testDiv.style[transform];
			}

			if (localFeatures.transform.prop) {
				// try to derive the rotate/3D support.
				transform = localFeatures.transform.prop;
				styles = {
					css_2d: 'rotate(0deg)',
					css_3d: 'rotate3d(0,0,0,0deg)'
				};

				if (attempt(styles.css_3d)) {
					localFeatures.rotate.has3D = true;
					prop = 'rotate3d';
				} else if (attempt(styles.css_2d)) {
					prop = 'rotate';
				}
				
				localFeatures.rotate.prop = prop;
			}

			testDiv = null;
			
			return localFeatures;
		}())
	};
</script>

</head>

<body>

<!-- player 4 -->
<div class="sm2-bar-ui full-width fixed flat" id="player">
<!--div class="sm2-bar-ui compact full-width"-->

 <div class="bd sm2-main-controls">

  <div class="sm2-inline-texture"></div>
  <div class="sm2-inline-gradient"></div>

  <div class="sm2-inline-element sm2-button-element">
   <div class="sm2-button-bd">
    <a href="#play" class="sm2-inline-button play-pause">Play / pause</a>
   </div>
  </div>

  <div class="sm2-inline-element sm2-inline-status">

   <div class="sm2-playlist">
    <div class="sm2-playlist-target">
     <!-- playlist <ul> + <li> markup will be injected here -->
     <!-- if you want default / non-JS content, you can put that here. -->
     <noscript><p>JavaScript is required.</p></noscript>
    </div>
   </div>

   <div class="sm2-progress">
    <div class="sm2-row">
    <div class="sm2-inline-time">0:00</div>
     <div class="sm2-progress-bd">
      <div class="sm2-progress-track">
       <div class="sm2-progress-bar"></div>
       <div class="sm2-progress-ball"><div class="icon-overlay"></div></div>
      </div>
     </div>
     <div class="sm2-inline-duration">0:00</div>
    </div>
   </div>

  </div>

  <div class="sm2-inline-element sm2-button-element sm2-volume">
   <div class="sm2-button-bd">
    <span class="sm2-inline-button sm2-volume-control volume-shade"></span>
    <a href="#volume" class="sm2-inline-button sm2-volume-control">volume</a>
   </div>
  </div>

 </div>

 <div class="bd sm2-playlist-drawer sm2-element">

  <div class="sm2-inline-texture">
   <div class="sm2-box-shadow"></div>
  </div>

  <!-- playlist content is mirrored here -->

  <div class="sm2-playlist-wrapper">
    <ul class="sm2-playlist-bd">
     <li id="playertitle">sample - sample</li>
    </ul>
  </div>

 </div>

</div>

<button id="doplay">Play</button>

</body>
</html>
